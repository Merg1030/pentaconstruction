<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>All Project Tasks | Task Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      body { font-family: 'Segoe UI', 'Roboto', sans-serif; background: #181a22; color: #e0e0e0; margin: 0; }
      .container { margin: 0 auto; padding: 8px; }
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; gap: 10px; }
      .btn { display: inline-flex; align-items: center; gap: 6px; padding: 5px 13px; border-radius: 7px; font-weight: 500; cursor: pointer; text-decoration: none; border: none; font-size: 13px; transition: all 0.2s ease; }
      .btn-outline { background: none; border: 1.2px solid #33394c; color: #4361ee; }
      .btn-outline:hover { background: #23263a; }
      .project-header {
        background: linear-gradient(90deg, #23263a 0%, #4361ee 100%);
        border-radius: 7px; margin-bottom: 12px; padding: 12px 10px;
        display: flex; flex-direction: column; gap: 7px;
        position: sticky; top: 0; z-index: 10;
      }
      .project-title-sticky {
        font-size: 19px; font-weight: 700; color: #4cc9f0; margin-bottom: 2px;
      }
      .project-meta { display: flex; flex-wrap: wrap; gap: 20px; font-size: 12px; }
      .project-meta label { color: #8ecae6; font-weight: 600; margin-right: 7px;}
      .filters-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 7px 10px; padding: 5px 5px 5px 8px; background: linear-gradient(90deg, #4361ee 0%, #4cc9f0 100%); border-radius: 7px; box-shadow: 0 1px 8px rgba(67, 97, 238, 0.08); margin-bottom: 9px;}
      .filter-group { display: flex; align-items: center; gap: 4px; background: #23263a; border-radius: 16px; padding: 3.5px 9px 3.5px 7px; box-shadow: 0 1px 4px rgba(67,97,238,0.04); flex: 1 1 70px; min-width: 70px; max-width: 100px; }
      .filter-label { font-size: 10px; font-weight: 600; color: #4361ee; }
      select { border: 1.2px solid #4361ee; border-radius: 10px; padding: 2px 4px; background: #23263a; color: #e0e0e0; font-size: 11px; min-width: 40px; }
      select:focus { outline: none; border-color: #4cc9f0;}
      .main-table-wrap { display: flex; flex-direction: row; align-items: stretch; width: 100%; transition: all 0.3s; }
      .card { background: #23263a; padding: 7px 4px 2px 4px; border-radius: 7px 0 0 7px; border: 1px solid #33394c; box-shadow: 0 2px 10px rgba(67, 97, 238, 0.07); margin-bottom: 0; flex: 1 1 65%; overflow-x: auto; transition: flex-basis 0.3s, width 0.3s; }
      .card.full-width { border-radius: 7px; flex: 1 1 100% !important; }
      .table-responsive { width: 100%; overflow-x: auto; }
      .task-table { width: 100%; border-collapse: collapse; font-size: 11px; }
      .task-table th, .task-table td { padding: 4px 2px; border-bottom: 1px solid #33394c; }
      .task-table th { background: #24263c; font-weight: 600; font-size: 10.5px; text-transform: uppercase; letter-spacing: 0.3px; position: sticky; top: 0; z-index: 1;}
      .task-table tr:nth-child(even) { background: #1f2233;}
      .task-table tr:hover { background: #2c314b;}
      .status-badge { display: inline-block; padding: 1.5px 5px; border-radius: 7px; font-size: 9.5px; font-weight: 600; }
      .status-completed { background: rgba(76, 201, 240, 0.1); color: #4cc9f0; border: 1px solid #4cc9f0; }
      .status-ongoing { background: rgba(248, 150, 30, 0.1); color: #f8961e; border: 1px solid #f8961e; }
      .status-pending { background: rgba(108, 117, 125, 0.13); color: #6c757d; border: 1px solid #6c757d; }
      .editable { cursor: pointer; border-radius: 5px; }
      .editable:hover { background: rgba(67, 97, 238, 0.09);}
      .editable-input, .editable-select { width: 100%; padding: 2px 3px !important; border-radius: 6px; border: 1.2px solid #4361ee; background: #23263a; color: #e0e0e0; font-size: 11px; }
      .cost-badge { display: inline-block; padding: 1.5px 5px; border-radius: 7px; font-size: 10px; font-weight: 600; background: rgba(67, 97, 238, 0.1); color: #4361ee; border: 1px solid #4361ee; }
      .empty-state { text-align: center; padding: 12px; color: #e0e0e0; opacity: 0.7; }
      .empty-state i { font-size: 20px; opacity: 0.5; }
      .gantt-table-card { background: #23263a; border-radius: 0 7px 7px 0; border-top: 1px solid #33394c; border-right: 1px solid #33394c; border-bottom: 1px solid #33394c; box-shadow: 0 2px 10px rgba(67, 97, 238, 0.07); margin-bottom: 0; min-width: 200px; max-width: 100%; flex: 1 1 35%; display: flex; flex-direction: column; justify-content: stretch; transition: max-width 0.3s, min-width 0.3s;}
      .gantt-table-card.hide { display: none !important; }
      .gantt-table-header { padding: 4px 3px 2px 7px; display: flex; align-items: center; font-size: 12px; color: #4cc9f0; font-weight: 600; justify-content: space-between; }
      .gantt-table-toggle { color: #4361ee; background: none; border: none; font-size: 18px; cursor: pointer; margin-left: 7px;}
      .toggle-bar { position: absolute; left: 0; top: 100px; z-index: 50; background: #23263a; color: #4361ee; border: 1px solid #4361ee; border-radius: 0 6px 6px 0;
        padding: 5px 8px; font-size: 15px; cursor: pointer; min-width: 18px; text-align: center; }
      .toggle-bar:hover { background: #4361ee; color: #fff; }
      .gantt-table-scroll { overflow-x: auto; height: 100%; }
      .gantt-table { width: max-content; border-collapse: collapse; font-size: 10px; height: 100%; min-width: 400px;}
      .gantt-table th, .gantt-table td { border: 1px solid #33394c; padding: 2px 3px; text-align: center; background: #23263a;}
      .gantt-table th { background: #181a22; color: #e0e0e0; position: sticky; top: 0; z-index: 2; font-size:10px;}
      .gantt-bar { background: #4cc9f0; border-radius: 4px; height: 7px; width: 90%; margin: 0 auto;}
      .gantt-bar-empty { background: transparent; }
      .gantt-pct { font-weight: bold; font-size: 10px;}
      .gantt-table tr { height: 22px; }
      .hide { display: none !important; }
      .subtask-row td { background: #20223a !important; color: #b0e0ff !important; }
      .subtask-row td.subtask-desc { padding-left: 24px !important; }
      .subtask-arrow { text-align: center; color: #4cc9f0; font-size: 15px; }
      .main-task-expand { cursor: pointer; color: #4361ee; margin-right: 6px; }
      .add-subtask-btn { color: #4cc9f0; background: none; border: none; cursor: pointer; font-size: 11px; margin-left: 7px;}
      .add-subtask-btn:hover { text-decoration: underline; }
      @media (max-width: 800px) {
        .main-table-wrap { flex-direction: column; }
        .gantt-table-card { max-width: 100%; min-width: 100%; border-radius: 0 0 7px 7px; }
        .card { border-radius: 7px 7px 0 0;}
      }
    </style>
</head>
<body class="dark-mode">
    <div class="container">
        <div class="header">
            <a href="dashboard.html" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
            <button class="btn btn-outline" id="toggleModeBtn"><i class="fas fa-moon"></i> Dark Mode</button>
        </div>
        <div class="project-header" id="projectHeaderSticky">
            <div class="project-title-sticky" id="projectNameHeader">HML-LUMUMBA REFURB</div>
            <div class="project-meta">
                <div><label>PROJECT TITLE:</label> <span id="projectTitleHeader">27450 Lumumba - HML - Refurbishment</span></div>
                <div><label>PROJECT MANAGER:</label> <span id="projectManagerHeader">Chishecc</span></div>
            </div>
        </div>
        <div class="filters-bar">
            <div class="filter-group"><span class="filter-label">Status:</span>
                <select id="statusFilter">
                    <option value="">All</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="ONGOING">Ongoing</option>
                    <option value="PENDING">Pending</option>
                </select>
            </div>
            <div>
                <button class="btn btn-outline" id="addTaskBtn"><i class="fas fa-plus"></i> Add Task</button>
            </div>
        </div>
        <div class="main-table-wrap" id="mainTableWrap" style="position:relative;">
            <div class="card" id="mainCard">
                <div class="card-header" style="padding: 3px 0 7px 0;">
                    <h2 class="card-title" style="font-size:13px; margin:0; color:#4361ee; font-weight:500">
                        <i class="fas fa-tasks"></i> All Tasks
                    </h2>
                </div>
                <div class="table-responsive">
                    <table class="task-table" id="taskTable">
                        <thead>
                            <tr>
                                <th></th>
                                <th>TASK ID</th>
                                <th>DESCRIPTION</th>
                                <th class="editable">ASSIGNED</th>
                                <th class="editable">LOCATION</th>
                                <th class="editable">STATUS</th>
                                <th class="editable">START DATE</th>
                                <th class="editable">END DATE</th>
                                <th class="editable">DURATION</th>
                                <th class="editable">MATERIAL COST</th>
                                <th class="editable">MAN COST</th>
                                <th class="editable">TOTAL COST</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="taskList"></tbody>
                    </table>
                </div>
                <div class="empty-state" id="emptyState" style="display:none;">
                    <i class="fas fa-tasks"></i>
                    <p>No tasks found.</p>
                </div>
            </div>
            <!-- Table Gantt (side) -->
            <div class="gantt-table-card" id="ganttTableCard">
                <div class="gantt-table-header">
                    <span><i class="fas fa-calendar-alt"></i> Gantt Calendar</span>
                    <button class="gantt-table-toggle" id="toggleGanttBtn" title="Show/hide calendar"><i class="fas fa-eye-slash"></i></button>
                </div>
                <div class="gantt-table-scroll" id="ganttTableScroll" style="height:100%">
                    <table class="gantt-table" style="height:100%">
                        <thead id="ganttCalendarHead"></thead>
                        <tbody id="ganttCalendarBody"></tbody>
                    </table>
                </div>
            </div>
            <button id="showGanttBtn" class="toggle-bar hide" title="Show Gantt Calendar"><i class="fas fa-calendar-alt"></i></button>
        </div>
    </div>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, onSnapshot, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";
    const firebaseConfig = {
        apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
        authDomain: "project-task-588c4.firebaseapp.com",
        projectId: "project-task-588c4",
        storageBucket: "project-task-588c4.appspot.com",
        messagingSenderId: "411882772509",
        appId: "1:411882772509:web:08d613186c101a99f38ef4",
        measurementId: "G-JMFLFYEM0F"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ganttTableCard = document.getElementById('ganttTableCard');
    const ganttTableScroll = document.getElementById('ganttTableScroll');
    const toggleGanttBtn = document.getElementById('toggleGanttBtn');
    const showGanttBtn = document.getElementById('showGanttBtn');
    const mainCard = document.getElementById('mainCard');
    let ganttVisible = true;
    toggleGanttBtn.onclick = () => {
      ganttVisible = !ganttVisible;
      ganttTableCard.classList.toggle('hide', !ganttVisible);
      mainCard.classList.toggle('full-width', !ganttVisible);
      showGanttBtn.classList.toggle('hide', ganttVisible);
      toggleGanttBtn.innerHTML =
        ganttVisible
        ? `<i class="fas fa-eye-slash"></i>`
        : `<i class="fas fa-eye"></i>`;
    };
    showGanttBtn.onclick = () => {
      ganttVisible = true;
      ganttTableCard.classList.remove('hide');
      mainCard.classList.remove('full-width');
      showGanttBtn.classList.add('hide');
      toggleGanttBtn.innerHTML = `<i class="fas fa-eye-slash"></i>`;
    };

    const toggleModeBtn = document.getElementById('toggleModeBtn');
    const statusFilter = document.getElementById('statusFilter');
    const taskList = document.getElementById('taskList');
    const emptyState = document.getElementById('emptyState');
    const ganttCalendarBody = document.getElementById('ganttCalendarBody');
    const ganttCalendarHead = document.getElementById('ganttCalendarHead');
    const body = document.body;
    const addTaskBtn = document.getElementById('addTaskBtn');

    toggleModeBtn.addEventListener('click', function() {
        body.classList.toggle('light-mode');
        if (body.classList.contains('light-mode')) {
            this.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
            localStorage.setItem('theme', 'light');
        } else {
            this.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            localStorage.setItem('theme', 'dark');
        }
    });
    if (localStorage.getItem('theme') === 'light') {
        body.classList.add('light-mode');
        toggleModeBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
    } else {
        toggleModeBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = dateString.toDate ? dateString.toDate() : new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    function formatDateForInput(dateString) {
        if (!dateString) return '';
        const date = dateString.toDate ? dateString.toDate() : new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    function formatCurrency(amount, curr='ZMW') {
        if (!amount && amount !== 0) return '';
        const formatter = new Intl.NumberFormat(undefined, {
            style: 'currency',
            currency: curr || 'ZMW',
            minimumFractionDigits: 2
        });
        return formatter.format(amount);
    }
    function getStatusBadge(status) {
        if (!status) return '';
        status = status.toUpperCase();
        if (status === 'COMPLETED') return 'status-badge status-completed';
        if (status === 'ONGOING') return 'status-badge status-ongoing';
        return 'status-badge status-pending';
    }

    let allTasks = [];
    let unsubMain = null;
    let subUnsubs = {};
    let expandedTasks = {};
    let subTaskCostMap = {};

    function loadExpandedTasks() {
      try {
        expandedTasks = JSON.parse(localStorage.getItem("chrischris_expanded_tasks") || "{}");
      } catch (e) { expandedTasks = {}; }
    }
    function saveExpandedTasks() {
      localStorage.setItem("chrischris_expanded_tasks", JSON.stringify(expandedTasks));
    }

    async function loadAllTasks(statusVal = '') {
      if (unsubMain) unsubMain();
      Object.values(subUnsubs).forEach(fn => fn && fn());
      subUnsubs = {};
      allTasks = [];
      subTaskCostMap = {};
      unsubMain = onSnapshot(query(collection(db, "chrischris")), async (snapshot) => {
        allTasks = [];
        let promises = [];
        snapshot.forEach(docSnap => {
          const docData = { id: docSnap.id, ...docSnap.data(), subTasks: [] };
          docData.expanded = expandedTasks[docSnap.id] || false;
          allTasks.push(docData);
          promises.push(new Promise((resolve) => {
            const unsub = onSnapshot(collection(db, "chrischris", docSnap.id, "subtasks"), (subSnap) => {
              docData.subTasks = [];
              let agg = {material:0, man:0, total:0, duration:0};
              let costPromises = [];
              subSnap.forEach(subDoc => {
                let subData = { id: subDoc.id, ...subDoc.data() };
                docData.subTasks.push(subData);
                costPromises.push(getSubtaskAggCosts(subData).then(costs => {
                  subData.materialCost = costs.materialCost;
                  subData.manCost = costs.manCost;
                  subData.totalCost = costs.totalCost;
                  subData.duration = costs.duration;
                  agg.material += subData.materialCost;
                  agg.man += subData.manCost;
                  agg.total += subData.totalCost;
                  agg.duration += subData.duration;
                }));
              });
              Promise.all(costPromises).then(() => {
                subTaskCostMap[docSnap.id] = agg;
                renderTasks(filterTasks(allTasks, statusFilter.value));
                renderGanttCalendar(filterTasks(allTasks, statusFilter.value));
                autoCompleteMainTaskIfNeeded(docSnap.id, docData, docData.subTasks);
                resolve();
              });
            });
            subUnsubs[docSnap.id] = unsub;
          }));
        });
        await Promise.all(promises);
        renderTasks(filterTasks(allTasks, statusFilter.value));
        renderGanttCalendar(filterTasks(allTasks, statusFilter.value));
      });
    }

    async function getSubtaskAggCosts(subData) {
      let materialCost = typeof subData.materialCost === 'number' ? subData.materialCost : 0;
      let manCost = typeof subData.manCost === 'number' ? subData.manCost : 0;
      let duration = typeof subData.duration === 'number' ? subData.duration : (parseFloat(subData.duration) || 0);
      let totalCost = typeof subData.totalCost === 'number'
        ? subData.totalCost
        : (materialCost + manCost);
      return {materialCost, manCost, totalCost, duration};
    }

    async function autoCompleteMainTaskIfNeeded(mainTaskId, mainDoc, subTasks) {
      if (!subTasks.length) return;
      if (subTasks.every(st => (st.status || '').toUpperCase() === "COMPLETED")) {
        if ((mainDoc.status || '').toUpperCase() !== "COMPLETED") {
          await updateDoc(doc(db, "chrischris", mainTaskId), { status: "COMPLETED", updatedAt: new Date() });
        }
      } else {
        if ((mainDoc.status || '').toUpperCase() === "COMPLETED") {
          await updateDoc(doc(db, "chrischris", mainTaskId), { status: "ONGOING", updatedAt: new Date() });
        }
      }
    }

    function filterTasks(tasks, statusFilterVal) {
      return tasks.filter(task => {
        const matchesStatus = !statusFilterVal || (task.status && task.status.toUpperCase() === statusFilterVal.toUpperCase());
        return matchesStatus;
      });
    }

    function renderTasks(tasks) {
      taskList.innerHTML = '';
      let visibleCount = 0;
      tasks.sort((a, b) => {
        const ad = a.startDate ? (a.startDate.toDate ? a.startDate.toDate() : new Date(a.startDate)) : 0;
        const bd = b.startDate ? (b.startDate.toDate ? b.startDate.toDate() : new Date(b.startDate)) : 0;
        return bd - ad;
      });
      tasks.forEach(task => {
        visibleCount++;
        const agg = subTaskCostMap[task.id] || {material:0, man:0, total:0, duration:0};
        const tr = document.createElement('tr');
        tr.classList.add('main-task-row');
        tr.innerHTML = `
          <td>
            <span class="main-task-expand" data-id="${task.id}" style="font-size:17px">
              <i class="fas fa-${task.expanded ? "caret-down" : "caret-right"}"></i>
            </span>
          </td>
          <td>${task.taskId || ''}</td>
          <td>${task.taskDescription || ''}</td>
          <td class="editable" data-type="main" data-field="assignedTo" data-id="${task.id}">${task.assignedTo || ''}</td>
          <td class="editable" data-type="main" data-field="location" data-id="${task.id}">${task.location || ''}</td>
          <td class="editable" data-type="main" data-field="status" data-id="${task.id}">
            <span class="${getStatusBadge(task.status)}">${task.status || ''}</span>
          </td>
          <td class="editable" data-type="main" data-field="startDate" data-id="${task.id}">${formatDate(task.startDate) || ''}</td>
          <td class="editable" data-type="main" data-field="endDate" data-id="${task.id}">${formatDate(task.endDate) || ''}</td>
          <td class="editable" data-type="main" data-field="duration" data-id="${task.id}">
            <span class="cost-badge">${agg.duration}</span>
          </td>
          <td class="material-cost-cell" data-taskcode="${task.taskId}">
            <span class="cost-badge">${formatCurrency(agg.material)}</span>
          </td>
          <td class="man-cost-cell" data-taskid="${task.id}" data-taskcode="${task.taskId}">
            <span class="cost-badge">${formatCurrency(agg.man)}</span>
          </td>
          <td class="total-cost-cell" data-taskid="${task.id}" data-taskcode="${task.taskId}">
            <span class="cost-badge">${formatCurrency(agg.total)}</span>
          </td>
          <td>
            <button class="add-subtask-btn" data-mainid="${task.id}">
              <i class="fas fa-plus"></i> Subtask
            </button>
          </td>
        `;
        taskList.appendChild(tr);

        if (task.expanded) {
          if (!task.subTasks || !task.subTasks.length) {
            const trSub = document.createElement('tr');
            trSub.classList.add('subtask-row');
            trSub.innerHTML = `<td></td><td colspan="11">No sub tasks yet.</td><td></td>`;
            taskList.appendChild(trSub);
          } else {
            task.subTasks.forEach(sub => {
              const trSub = document.createElement('tr');
              trSub.classList.add('subtask-row');
              trSub.innerHTML = `
                <td class="subtask-arrow">↪</td>
                <td></td>
                <td class="subtask-desc">${sub.taskDescription || ''}</td>
                <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="assignedTo" data-id="${sub.id}">${sub.assignedTo || ''}</td>
                <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="location" data-id="${sub.id}">${sub.location || ''}</td>
                <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="status" data-id="${sub.id}">
                  <span class="${getStatusBadge(sub.status)}">${sub.status || ''}</span>
                </td>
                <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="startDate" data-id="${sub.id}">${formatDate(sub.startDate) || ''}</td>
                <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="endDate" data-id="${sub.id}">${formatDate(sub.endDate) || ''}</td>
                <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="duration" data-id="${sub.id}">
                  <span class="cost-badge">${sub.duration || 0}</span>
                </td>
                <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="materialCost" data-id="${sub.id}">
                  ${typeof sub.materialCost === "number" ? `<span class="cost-badge">${formatCurrency(sub.materialCost)}</span>` : ""}
                </td>
                <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="manCost" data-id="${sub.id}">
                  ${typeof sub.manCost === "number" ? `<span class="cost-badge">${formatCurrency(sub.manCost)}</span>` : ""}
                </td>
                <td class="editable" data-type="sub" data-mainid="${task.id}" data-field="totalCost" data-id="${sub.id}">
                  ${typeof sub.totalCost === "number" ? `<span class="cost-badge">${formatCurrency(sub.totalCost)}</span>` : ""}
                </td>
                <td></td>
              `;
              taskList.appendChild(trSub);
            });
          }
        }
      });

      emptyState.style.display = visibleCount === 0 ? 'block' : 'none';

      document.querySelectorAll('.main-task-expand').forEach(btn => {
        btn.onclick = () => {
          const mainId = btn.dataset.id;
          expandedTasks[mainId] = !expandedTasks[mainId];
          saveExpandedTasks();
          allTasks.find(t => t.id === mainId).expanded = expandedTasks[mainId];
          renderTasks(filterTasks(allTasks, statusFilter.value));
          renderGanttCalendar(filterTasks(allTasks, statusFilter.value));
        };
      });

      document.querySelectorAll('.add-subtask-btn').forEach(btn => {
        btn.onclick = () => {
          const mainId = btn.dataset.mainid;
          addSubtask(mainId);
        };
      });

      document.querySelectorAll('.editable').forEach(cell => {
        cell.onclick = function() {
          const type = this.dataset.type;
          const field = this.dataset.field;
          if (field === 'status') {
            makeEditableSelect(this, type, field);
          } else if (field === 'startDate' || field === 'endDate') {
            makeEditableInput(this, type, field, 'date');
          } else if (field === 'materialCost' || field === 'manCost' || field === 'totalCost' || field === 'duration') {
            makeEditableInput(this, type, field, 'number');
          } else {
            makeEditableInput(this, type, field, 'text');
          }
        };
      });
    }

    addTaskBtn.onclick = async () => {
      const taskDesc = prompt("Main Task Description:");
      if (!taskDesc) return;
      const assignedTo = prompt("Assigned To:");
      const location = prompt("Location:");
      const status = prompt("Status (COMPLETED, ONGOING, PENDING):", "PENDING") || "PENDING";
      const startDate = prompt("Start Date (YYYY-MM-DD):");
      const endDate = prompt("End Date (YYYY-MM-DD):");
      const duration = parseFloat(prompt("Duration (number, optional):") || 0);
      const taskId = `T${Date.now()}`;
      try {
        await addDoc(collection(db, "chrischris"), {
          taskId, taskDescription: taskDesc, assignedTo, location,
          status: status.toUpperCase(),
          startDate: startDate ? new Date(startDate) : null,
          endDate: endDate ? new Date(endDate) : null,
          duration,
          createdAt: new Date(),
          updatedAt: new Date()
        });
        alert('Main task added!');
      } catch (e) {
        alert("Error adding main task: " + e.message);
      }
    };

    async function addSubtask(mainId) {
      const taskDesc = prompt("Sub Task Description:");
      if (!taskDesc) return;
      const assignedTo = prompt("Assigned To:");
      const location = prompt("Location:");
      const status = prompt("Status (COMPLETED, ONGOING, PENDING):", "PENDING") || "PENDING";
      const startDate = prompt("Start Date (YYYY-MM-DD):");
      const endDate = prompt("End Date (YYYY-MM-DD):");
      const duration = parseFloat(prompt("Duration (number, optional):") || 0);
      const materialCost = parseFloat(prompt("Material Cost (number, optional):") || 0);
      const manCost = parseFloat(prompt("Man Cost (number, optional):") || 0);
      const totalCost = materialCost + manCost;
      const taskId = `S${Date.now()}`;
      try {
        await addDoc(collection(db, "chrischris", mainId, "subtasks"), {
          taskId, taskDescription: taskDesc, assignedTo, location,
          status: status.toUpperCase(),
          startDate: startDate ? new Date(startDate) : null,
          endDate: endDate ? new Date(endDate) : null,
          duration,
          materialCost,
          manCost,
          totalCost,
          createdAt: new Date(),
          updatedAt: new Date()
        });
      } catch (e) {
        alert("Error adding sub task: " + e.message);
      }
    }

    function makeEditableInput(cell, type, field, inputType='text') {
      if (cell.querySelector('input')) return;
      const val = cell.textContent.trim();
      const input = document.createElement('input');
      input.type = inputType;
      if (inputType === 'date') {
        input.value = val ? formatDateForInput(val) : '';
      } else {
        input.value = val;
      }
      input.className = 'editable-input';
      cell.innerHTML = '';
      cell.appendChild(input);
      input.focus();
      input.onblur = async () => {
        let newValue = input.value;
        if (inputType === 'date' && newValue) newValue = new Date(newValue);
        if (inputType === 'number') newValue = parseFloat(newValue) || 0;
        await saveEditable(cell, type, field, newValue);
      };
      input.onkeypress = async (e) => {
        if (e.key === 'Enter') {
          input.blur();
        }
      };
    }
    function makeEditableSelect(cell, type, field) {
      if (cell.querySelector('select')) return;
      const val = cell.textContent.trim();
      const select = document.createElement('select');
      select.className = 'editable-select';
      ['COMPLETED', 'ONGOING', 'PENDING'].forEach(opt => {
        const o = document.createElement('option');
        o.value = opt;
        o.textContent = opt;
        if (val.toUpperCase() === opt) o.selected = true;
        select.appendChild(o);
      });
      cell.innerHTML = '';
      cell.appendChild(select);
      select.focus();
      select.onblur = async () => {
        await saveEditable(cell, type, field, select.value);
      };
      select.onchange = () => select.blur();
    }
    async function saveEditable(cell, type, field, newVal) {
      const mainId = cell.dataset.mainid || cell.dataset.id;
      if (type === 'main') {
        await updateDoc(doc(db, "chrischris", mainId), { [field]: newVal, updatedAt: new Date() });
      } else if (type === 'sub') {
        await updateDoc(doc(db, "chrischris", mainId, "subtasks", cell.dataset.id), { [field]: newVal, updatedAt: new Date() });
      }
    }

    function buildGanttCalendarHeaders(baseYear) {
      const months = [
        {name: "Jan", days: 31},{name:"Feb",days:28},{name:"Mar",days:31},{name:"Apr",days:30},
        {name:"May",days:31},{name:"Jun",days:30},{name:"Jul",days:31},{name:"Aug",days:31},
        {name:"Sep",days:30},{name:"Oct",days:31},{name:"Nov",days:30},{name:"Dec",days:31}
      ];
      if ((baseYear % 4 === 0 && baseYear % 100 !== 0) || baseYear % 400 === 0) {
        months[1].days = 29;
      }
      let row1 = `<tr><th rowspan="3" style="min-width:160px;text-align:left;">TASK</th>`;
      months.forEach(m => row1 += `<th colspan="${m.days}">${m.name}</th>`);
      row1 += "</tr>";
      let row2 = "<tr>";
      months.forEach(m => {
        for(let d=1;d<=m.days;d++) row2 += `<th>${d}</th>`;
      });
      row2 += "</tr>";
      let row3 = "<tr>";
      months.forEach(m => {
        for(let d=1;d<=m.days;d++) {
          const dt = new Date(baseYear, months.indexOf(m), d);
          const wd = ["S","M","T","W","R","F","S"][dt.getDay()];
          row3 += `<th>${wd}</th>`;
        }
      });
      row3 += "</tr>";
      ganttCalendarHead.innerHTML = row1 + row2 + row3;
      return {months};
    }

    function renderGanttCalendar(tasks) {
      // Gather both main and all subtasks as separate rows
      let allRows = [];
      let minYear = new Date().getFullYear();
      tasks.forEach(main => {
        // Main task row
        allRows.push({
          isSub: false,
          description: main.taskDescription || '',
          status: main.status,
          startDate: main.startDate,
          endDate: main.endDate
        });
        if (main.startDate) {
          const y = (main.startDate.toDate ? main.startDate.toDate() : new Date(main.startDate)).getFullYear();
          if (y < minYear) minYear = y;
        }
        (main.subTasks || []).forEach(sub => {
          allRows.push({
            isSub: true,
            description: sub.taskDescription || '',
            status: sub.status,
            startDate: sub.startDate,
            endDate: sub.endDate
          });
          if (sub.startDate) {
            const y = (sub.startDate.toDate ? sub.startDate.toDate() : new Date(sub.startDate)).getFullYear();
            if (y < minYear) minYear = y;
          }
        });
      });
      const { months } = buildGanttCalendarHeaders(minYear);
      ganttCalendarBody.innerHTML = "";
      allRows.forEach(rowTask => {
        let pct = "";
        if (rowTask.status && rowTask.status.toUpperCase() === "COMPLETED") pct = "100%";
        else if (rowTask.status && rowTask.status.toUpperCase() === "ONGOING") pct = "60%";
        else if (rowTask.status && rowTask.status.toUpperCase() === "PENDING") pct = "0%";
        else pct = "";
        // First cell: description (with indent and arrow for subtask)
        let desc = rowTask.isSub
          ? '<span style="margin-left:12px;color:#4cc9f0;font-size:13px;vertical-align:middle;">↪</span> <span style="opacity:.8;">' + rowTask.description + '</span>'
          : '<span style="font-weight:bold;color:#4cc9f0;">' + rowTask.description + '</span>';
        let row = `<tr><td style="text-align:left">${desc}</td>`;
        let start = null, end = null;
        if (rowTask.startDate && rowTask.endDate) {
          start = rowTask.startDate.toDate ? rowTask.startDate.toDate() : new Date(rowTask.startDate);
          end = rowTask.endDate.toDate ? rowTask.endDate.toDate() : new Date(rowTask.endDate);
          start = new Date(start.getFullYear(), start.getMonth(), start.getDate());
          end = new Date(end.getFullYear(), end.getMonth(), end.getDate());
        }
        let colDate = new Date(minYear, 0, 1);
        for (let m = 0; m < months.length; m++) {
          for (let d = 1; d <= months[m].days; d++) {
            let bar = '';
            if (start && end) {
              let testDate = new Date(colDate.getFullYear(), colDate.getMonth(), colDate.getDate());
              if (testDate >= start && testDate <= end) {
                if (!rowTask.isSub) {
                  // Main task: blue
                  if (pct === "100%") bar = '<div class="gantt-bar"></div>';
                  else if (pct === "60%") bar = '<div class="gantt-bar" style="background:#ffe066"></div>';
                  else bar = '<div class="gantt-bar gantt-bar-empty"></div>';
                } else {
                  // Subtask: teal
                  if (pct === "100%") bar = '<div class="gantt-bar" style="background:#4cc9f0;opacity:.6"></div>';
                  else if (pct === "60%") bar = '<div class="gantt-bar" style="background:#90e0ef"></div>';
                  else bar = '<div class="gantt-bar gantt-bar-empty"></div>';
                }
              }
            }
            row += `<td>${bar}</td>`;
            colDate.setDate(colDate.getDate() + 1);
          }
        }
        row += `</tr>`;
        ganttCalendarBody.innerHTML += row;
      });
    }

    loadExpandedTasks();
    statusFilter.addEventListener('change', () => {
      loadAllTasks(statusFilter.value);
    });
    loadAllTasks(statusFilter.value);
    </script>
</body>
</html>
